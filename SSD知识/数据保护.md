# 数据保护

<https://access.redhat.com/solutions/41548>

DIF/DIX（也称为 PI），DIF 是最近添加到 SCSI 标准中的一项新功能。它在磁盘上每个扇区的末尾添加 8 个字节。

```txt
       bit→
↓byte       7        6         5         4         3         2         1         0
       +--------+---------+---------+---------+---------+---------+---------+---------+
  0    |                                                                              |
       +---                                                                        ---+
       :                                  User Data                                   :
       +---                                                                        ---+
 n-1   |                                                                              | where n=512|4096
       +--------+---------+---------+---------+---------+---------+---------+---------+
       +--------+---------+---------+---------+---------+---------+---------+---------+
  n    | (msb)                                                                        |
       +--------          Logical Block Guard (CRC16 e.g.)                   ---------+
 n+1   |                                                                        (lsb) |
       +--------+---------+---------+---------+---------+---------+---------+---------+
 n+2   | (msb)                                                                        |
       +--------          Logical Block Application Tag                      ---------+
 n+3   |                                                                        (lsb) |
       +--------+---------+---------+---------+---------+---------+---------+---------+
 n+4   |                                                                              |
       +---                                                                        ---+
       :                  Logical Block Reference Tag                                 :
       +---                                                                        ---+
 n+7   |                                                                              |
       +--------+---------+---------+---------+---------+---------+---------+---------+
```

其中n到n+7就是添加的字节。它将常用的 512 字节磁盘块的大小从 512 字节增加到 520 字节。

- 额外的字节包括数据完整性字段 (DIF)。基本思想是 HBA 将在写入时为数据块计算校验和值，并将其存储在 DIF 中。存储设备将在接收时确认校验和，并存储数据和校验和。读取时，存储设备和接收 HBA 将检查校验和。（可见DIF提供数据的端到端保护）
- 数据完整性扩展 (DIX) 允许**此检查向上移动堆栈**：应用程序计算校验和并将其传递给 HBA，以附加到 512 字节数据块。这提供了完整的端到端数据完整性检查。

SPDK中通过以下方式判断是否支持PI：

```cpp
struct spdk_nvme_ns *ns;
if (spdk_nvme_ns_get_flags(ns) & SPDK_NVME_NS_DPS_PI_SUPPORTED) {
	printf("[硬件特性]：设备【支持】数据端到端保护\n");
	entry->io_flags = g_metacfg_pract_flag | g_metacfg_prchk_flags;
} else {
	printf("[硬件特性]：设备【不支持】数据端到端保护\n");
}

// 获取数据保护类型
entry->pi_type = spdk_nvme_ns_get_pi_type(ns);
```

SPDK中扩展块即代表设备支持DIF（扩展的8字节暴露给上层用户），否则是DIX。

